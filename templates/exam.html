{% extends "index.html" %}

{% block title %}Quiz{% endblock %}

{% block content %}
<div class="card vh-100">
  <div class="card-body d-flex flex-column h-100 p-3">

    <div class="row g-2 mb-2">
      <div class="col-md-8">
        <div class="d-flex align-items-center mb-2">
          <div class="btn-group btn-group-sm me-4" role="group">
            <button type="button" class="btn btn-outline-secondary" onclick="adjustFontSize(-1)">A-</button>
            <button type="button" class="btn btn-outline-secondary" onclick="adjustFontSize(1)">A+</button>
          </div>
          <div class="flex-grow-1">
            <div class="text-sm text-secondary mb-2">
              There are {{ quiz.num_questions }} questions, and your progress of answering is
            </div>
            <div class="progress" style="height: 8px;">
              <div class="progress-bar bg-success" id="progress-bar" role="progressbar" style="width: 0%"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4 text-end">
        <span class="badge bg-primary" id="timer"><span id="time">00:00</span></span>
      </div>
    </div>


    <form method="POST" action="{{ url_for('submit') }}" id="quizForm" class="flex-grow-1 d-flex flex-column">
      <input type="hidden" name="answers" id="answersInput" value="[]">
      <div class="row flex-grow-1">

        <div class="col-md-3 border-end py-2">
          <div class="mb-2" id="selectInfo">
            Choose your answer(s) - Select {{ quiz.questions[0].correct_answers|length }} option(s)
          </div>
          <div class="answer-options">

          </div>

          <div class="mt-4 d-flex"> <!-- Changed from mt-3 to mt-4 -->
            <button type="button" class="btn btn-secondary me-2" id="prevBtn" disabled>Back</button>
            <button type="button" class="btn btn-primary" id="nextBtn">Next</button>
          </div>
        </div>


        <div class="col-md-9 py-2">
          <div id="questionContent" class="h-100 d-flex flex-column">
            <div class="question-text mb-3"></div>
            <div class="options-text flex-grow-1">

            </div>
          </div>
        </div>
      </div>


      <div class="mt-2 pt-2 border-top text-end">
        <div class="form-check d-inline-block">
          <input class="form-check-input" type="checkbox" id="finishCheck">
          <label class="form-check-label" for="finishCheck">
            I want to finish the exam.
          </label>
          <button type="submit" class="btn btn-success mt-2 d-block ms-auto" id="finishBtn" disabled>Finish</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
  const questions = {{ quiz.questions| tojson | safe }};
  let currentQuestion = 0;
  let answers = new Array(questions.length).fill(null);
  let timeLimit = {{ time_limit }} * 60;
  const quizToken = '{{ quiz.token }}';

  if (!window.location.search.includes('token') && quizToken) {
    const newUrl = `${window.location.pathname}?token=${quizToken}`;
    window.history.pushState({}, '', newUrl);
  }

  function saveProgress() {
    localStorage.setItem(`quiz_${quizToken}`, JSON.stringify({
      answers,
      timeLimit,
      currentQuestion
    }));
  }

  function loadProgress() {
    const saved = localStorage.getItem(`quiz_${quizToken}`);
    if (saved) {
      const data = JSON.parse(saved);
      answers = data.answers;
      timeLimit = data.timeLimit;
      currentQuestion = data.currentQuestion;
      document.getElementById('answersInput').value = JSON.stringify(answers);
      updateQuestion();
      updateProgress();
    }
  }

  function updateQuestion() {
    const question = questions[currentQuestion];
    document.getElementById('selectInfo').textContent =
      `Choose your answer(s) - Select ${question.correct_answers.length} option(s)`;

    const questionTextEl = document.querySelector('.question-text');
    questionTextEl.innerHTML = question.text.replace(/\n/g, '<br>');
    if (question.image_url) {
      questionTextEl.innerHTML += `
            <div class="question-image mt-2">
                <img src="${question.image_url}" alt="Question image" class="img-fluid">
            </div>`;
    }

    // Update the option selection panel (left side checkboxes)
    const optionsPanel = document.querySelector('.answer-options');
    optionsPanel.innerHTML = question.options
      .map((option, index) => {
        const letter = String.fromCharCode(65 + index);
        return `<div class="form-check"><input class="form-check-input" type="checkbox" name="answer_option" id="option${letter}" value="${letter}"><label class="form-check-label text-nowrap" for="option${letter}">${letter}</label></div>`;
      }).join('');

    // Update the option content panel (right side)
    const optionsContainer = document.querySelector('.options-text');
    optionsContainer.innerHTML = question.options
      .map((option, index) => {
        const letter = String.fromCharCode(65 + index);
        return option.type === 'image'
          ? `<div class="option-row"><span class="option-letter">${letter}.</span><div class="option-image"><img src="${option.content}" alt="Option ${letter}" class="img-fluid"></div></div>`
          : `<div class="option-row"><span class="option-letter text-nowrap">${letter}. </span><span class="option-content">${option.content.replace(/\n/g, '<br>')}</span></div>`;
      }).join('');

    document.querySelectorAll('input[name="answer_option"]').forEach(cb => cb.checked = false);

    if (answers[currentQuestion]) {
      const savedAnswers = answers[currentQuestion];
      savedAnswers.forEach(answer => {
        const index = question.options.indexOf(answer);
        if (index !== -1) {
          document.getElementById(`option${String.fromCharCode(65 + index)}`).checked = true;
        }
      });
    }

    document.getElementById('prevBtn').disabled = false;

    updateProgress();

    optionsPanel.style.height = 'auto';
    optionsPanel.style.maxHeight = '300px'; // Only scroll if content exceeds this height
    optionsPanel.style.minHeight = '200px'; // Ensure minimum height for visual consistency
  }

  function updateProgress() {
    const answered = answers.filter(answer => answer !== null).length;
    const progress = (answered / questions.length) * 100;
    document.getElementById('progress-bar').style.width = `${progress}%`;
  }

  function updateAnswers() {
    const question = questions[currentQuestion];
    const selectedLetters = Array.from(
      document.querySelectorAll('input[name="answer_option"]:checked')
    ).map(cb => cb.value);

    const selectedAnswers = selectedLetters.map(letter =>
      question.options[letter.charCodeAt(0) - 65]
    );

    answers[currentQuestion] = selectedAnswers;
    document.getElementById('answersInput').value = JSON.stringify(answers);
    updateProgress();
    saveProgress();
  }

  document.querySelector('.answer-options').addEventListener('change', updateAnswers);

  document.getElementById('prevBtn').addEventListener('click', () => {
    currentQuestion = currentQuestion === 0 ? questions.length - 1 : currentQuestion - 1;
    updateQuestion();
    saveProgress();
  });

  document.getElementById('nextBtn').addEventListener('click', () => {
    currentQuestion = (currentQuestion + 1) % questions.length;
    updateQuestion();
    saveProgress();
  });

  document.getElementById('finishCheck').addEventListener('change', (e) => {
    document.getElementById('finishBtn').disabled = !e.target.checked;
  });

  function updateTimer() {
    const minutes = Math.floor(timeLimit / 60);
    const seconds = timeLimit % 60;
    document.getElementById('time').textContent =
      `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

    if (timeLimit <= 0) {
      document.getElementById('quizForm').submit();
    } else {
      timeLimit--;
      setTimeout(updateTimer, 1000);
    }
  }

  document.getElementById('quizForm').addEventListener('submit', () => {
    localStorage.removeItem(`quiz_${quizToken}`);
  });

  updateQuestion();
  updateTimer();
  loadProgress();

  let currentFontSize = 1; // 1 represents the default size

  function adjustFontSize(delta) {
    currentFontSize = Math.max(0.8, Math.min(1.4, currentFontSize + delta * 0.1));
    document.querySelector('.question-text').style.fontSize = `${currentFontSize * 1.1}rem`;
    document.querySelector('.options-text').style.fontSize = `${currentFontSize}rem`;
    
    // Add these lines to adjust option letters and content
    document.querySelectorAll('.option-letter').forEach(el => {
      el.style.fontSize = `${currentFontSize * 1.1}rem`;
    });
    document.querySelectorAll('.option-content').forEach(el => {
      el.style.fontSize = `${currentFontSize}rem`;
    });
  }
</script>

<style>
  .card {
    margin: -1.5rem;
    border-radius: 0;
    height: 100vh;

    border: none;
  }

  .question-text {
    font-size: 1.3rem;
    font-weight: 500;
    margin-bottom: 0.5rem;
    white-space: pre-wrap;

  }

  .options-text {
    font-size: 1.2rem;
    line-height: 1.5;
    overflow-y: auto;
    padding-right: 0.5rem;
  }


  .options-text::-webkit-scrollbar {
    width: 6px;
  }

  .options-text::-webkit-scrollbar-track {
    background: #f1f1f1;
  }

  .options-text::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 3px;
  }


  .answer-options .form-check {
    margin-bottom: 0.5rem;
  }

  .answer-options .form-check:last-child {
    margin-bottom: 0;
  }


  @media (max-height: 600px) {
    .card-body {
      padding: 0.5rem;
    }

    .question-text {
      font-size: 1.2rem;
    }

    .options-text {
      font-size: 1rem;
      line-height: 1.4;
    }
  }


  .answer-options {
    position: relative;
    margin-bottom: 1rem;
    padding-left: 2px;
    /* Creates space for checkbox glow */
    height: auto !important;
    /* Override any inline height */
    max-height: 300px;
    min-height: 200px;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }


  .answer-options+.mt-3 {
    position: sticky;
    bottom: 0;
    background: white;
    padding-top: 0.5rem;
    border-top: 1px solid #dee2e6;
  }


  .form-check {
    height: 38px;
    /* Increased from 32px */
    display: flex;
    align-items: center;
    padding-left: 2.2em;
    /* Increased padding for larger checkboxes */
  }

  .form-check-input {
    width: 1.3em;
    height: 1.3em;
    margin-right: 0.6em;
    transition: border-color 0.2s ease;
  }

  .form-check-input:hover {
    border-color: #0d6efd;
  }

  .form-check-label {
    font-size: 1.1rem;
  }

  .question-image,
  .option-image {
    max-width: 100%;
    margin: 1rem 0;
    text-align: center;
  }

  .question-image img,
  .option-image img {
    max-height: 300px;
    object-fit: contain;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 0.5rem;
  }


  .option-text {
    white-space: pre-line;

    margin-left: 1.5rem;

  }

  .mb-3 {
    margin-bottom: 1.5rem !important;

  }

  .option-row {
    display: flex;
    margin-bottom: 1rem;
    align-items: flex-start;
  }

  .option-letter {
    flex: 0 0 2.5rem;
    /* Increased from 2rem */
    font-weight: 500;
    white-space: nowrap;
    padding-right: 0.5rem;
    font-size: 1.1rem;
  }

  .option-content {
    font-size: 1.15rem;
    flex: 1;
  }

  .option-image {
    flex: 1;
    margin-left: 0.5rem;
  }

  .text-nowrap {
    white-space: nowrap;
  }

  .badge {
    font-size: 1.4rem;
    padding: 0.6rem 1rem;
    border-radius: 6px;
  }

  #finishCheck:hover {
    border-color: #198754;
  }

  @media (max-width: 768px) {
    .col-md-3 {
      border-bottom: 1px solid #dee2e6;
      border-right: none !important;
      margin-bottom: 1rem;
    }

    .option-row {
      flex-direction: column;
    }

    .option-letter {
      margin-bottom: 0.5rem;
    }

    .badge {
      font-size: 1.2rem;
      padding: 0.5rem 0.8rem;
    }
  }
  }
</style>
{% endblock %}